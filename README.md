# hhplus_tdd
ν•­ν•΄ 99 - TDD κΈ°λ³Έ λ‹¤μ§€κΈ° κ³Όμ 

## ν”„λ΅μ νΈ κ°μ”
ν¬μΈνΈ μ¶©μ „/μ‚¬μ© κΈ°λ¥μ„ μ κ³µν•λ” REST API μ„λ²„μ…λ‹λ‹¤.
TDD(Test-Driven Development) λ°©μ‹μΌλ΅ κ°λ°λμ—μΌλ©°, λ™μ‹μ„± μ μ–΄λ¥Ό ν†µν• λ°μ΄ν„° μ •ν•©μ„± λ³΄μ¥μ— μ¤‘μ μ„ λ‘κ³  μμµλ‹λ‹¤.

## μ£Όμ” κΈ°λ¥
- μ‚¬μ©μ ν¬μΈνΈ μ΅°ν
- ν¬μΈνΈ μ¶©μ „
- ν¬μΈνΈ μ‚¬μ©  
- ν¬μΈνΈ μ‚¬μ© λ‚΄μ—­ μ΅°ν

## ν…μ¤νΈ κµ¬μ΅°

### π“ Controller Layer ν…μ¤νΈ
**`src/test/java/io/hhplus/tdd/controller/`**
- `PointControllerTest.java` - `PointController.java` ν…μ¤νΈ
  - ν¬μΈνΈ μ΅°ν API ν…μ¤νΈ
  - ν¬μΈνΈ μ¶©μ „ API ν…μ¤νΈ
  - ν¬μΈνΈ μ‚¬μ© API ν…μ¤νΈ
  - ν¬μΈνΈ λ‚΄μ—­ μ΅°ν API ν…μ¤νΈ
  - λ³µν•© μ‹λ‚λ¦¬μ¤ ν†µν•© ν…μ¤νΈ

### π“ Service Layer ν…μ¤νΈ
**`src/test/java/io/hhplus/tdd/service/`**
- `PointServiceTest.java` - `PointService.java` ν…μ¤νΈ
  - ν¬μΈνΈ μ΅°ν λΉ„μ¦λ‹μ¤ λ΅μ§ ν…μ¤νΈ
  - ν¬μΈνΈ μ¶©μ „ λΉ„μ¦λ‹μ¤ λ΅μ§ ν…μ¤νΈ
  - ν¬μΈνΈ μ‚¬μ© λΉ„μ¦λ‹μ¤ λ΅μ§ ν…μ¤νΈ
  - μμ™Έ μƒν™© μ²λ¦¬ ν…μ¤νΈ

### π“ Integration ν…μ¤νΈ
**`src/test/java/io/hhplus/tdd/integration/`**
- `ConcurrencyControlTest.java` - λ™μ‹μ„± μ μ–΄ ν†µν•© ν…μ¤νΈ
  - λ™μ‹ ν¬μΈνΈ μ¶©μ „ λ°μ΄ν„° μ •ν•©μ„± κ²€μ¦
  - λ™μ‹ ν¬μΈνΈ μ‚¬μ© μ‹ μ”κ³  μ΄κ³Ό λ°©μ§€ κ²€μ¦
  - μ¶©μ „/μ‚¬μ© λ³µν•© μ‹λ‚λ¦¬μ¤ μ •ν•©μ„± κ²€μ¦
  - λ‹¤μ¤‘ μ‚¬μ©μ λ…λ¦½μ  μ²λ¦¬ κ²€μ¦

## λ™μ‹μ„± μ μ–΄ λ¶„μ„ λ³΄κ³ μ„

### 1. λ¬Έμ  μƒν™© λ¶„μ„

#### 1.1 Race Condition λ°μƒ μ‹λ‚λ¦¬μ¤
ν¬μΈνΈ μ‹μ¤ν…μ—μ„ λ™μ‹μ„± λ¬Έμ κ°€ λ°μƒν•  μ μλ” μ£Όμ” μ‹λ‚λ¦¬μ¤λ” λ‹¤μκ³Ό κ°™μµλ‹λ‹¤:

```java
// μ‹λ‚λ¦¬μ¤: λ™μΌ μ‚¬μ©μκ°€ λ™μ‹μ— ν¬μΈνΈ μ‚¬μ©μ„ μ”μ²­ν•λ” κ²½μ°
// Thread 1: 1000 ν¬μΈνΈμ—μ„ 500 ν¬μΈνΈ μ‚¬μ©
// Thread 2: 1000 ν¬μΈνΈμ—μ„ 300 ν¬μΈνΈ μ‚¬μ©

// Race Condition λ°μƒ μ‹:
// 1. Thread 1μ΄ ν„μ¬ ν¬μΈνΈ 1000μ„ μ΅°ν
// 2. Thread 2λ„ λ™μ‹μ— ν„μ¬ ν¬μΈνΈ 1000μ„ μ΅°ν  
// 3. Thread 1μ΄ 1000 - 500 = 500μΌλ΅ μ—…λ°μ΄νΈ
// 4. Thread 2κ°€ 1000 - 300 = 700μΌλ΅ μ—…λ°μ΄νΈ
// κ²°κ³Ό: μ‹¤μ λ΅λ” 200 ν¬μΈνΈκ°€ λ‚¨μ•„μ•Ό ν•μ§€λ§ 700 ν¬μΈνΈκ°€ λ‚¨κ² λ¨
```

#### 1.2 λ°μ΄ν„° λ¶μΌμΉ λ¬Έμ μ 
- **Lost Update**: ν• νΈλμ­μ…μ μ—…λ°μ΄νΈκ°€ λ‹¤λ¥Έ νΈλμ­μ…μ— μν•΄ λ®μ–΄μ“°μ—¬μ§€λ” λ¬Έμ 
- **Dirty Read**: μ»¤λ°‹λμ§€ μ•μ€ λ°μ΄ν„°λ¥Ό μ½λ” λ¬Έμ 
- **Phantom Read**: κ°™μ€ μΏΌλ¦¬λ¥Ό μ‹¤ν–‰ν–μ„ λ• κ²°κ³Όκ°€ λ‹¬λΌμ§€λ” λ¬Έμ 

### 2. λ™μ‹μ„± μ μ–΄ λ°©μ‹ λΉ„κµ λ¶„μ„

#### 2.1 Java Synchronized ν‚¤μ›λ“
```java
public synchronized UserPoint chargeUserPoint(long userId, long amount) {
    // λ©”μ„λ“ μ „μ²΄μ— λ½ μ μ©
}
```

**μ¥μ :**
- κµ¬ν„μ΄ κ°„λ‹¨ν•κ³  μ§κ΄€μ 
- JVM λ λ²¨μ—μ„ μ§€μ›ν•μ—¬ μ•μ •μ 
- λ°λ“λ½ κ°€λ¥μ„±μ΄ μƒλ€μ μΌλ΅ λ‚®μ

**λ‹¨μ :**
- λ©”μ„λ“ μ „μ²΄μ— λ½μ΄ κ±Έλ ¤ μ„±λ¥ μ €ν• κ°€λ¥
- μ‚¬μ©μλ³„ μ„Έλ¶„ν™”λ λ½ μ μ–΄κ°€ μ–΄λ ¤μ›€
- ν™•μ¥μ„± μ ν•

#### 2.2 ReentrantLock (java.util.concurrent)
```java
private final ReentrantLock lock = new ReentrantLock();

public UserPoint chargeUserPoint(long userId, long amount) {
    lock.lock();
    try {
        // λΉ„μ¦λ‹μ¤ λ΅μ§
    } finally {
        lock.unlock();
    }
}
```

**μ¥μ :**
- λ” μ„Έλ°€ν• λ½ μ μ–΄ κ°€λ¥
- tryLock()μΌλ΅ νƒ€μ„μ•„μ›ƒ μ„¤μ • κ°€λ¥
- κ³µμ •μ„±(fairness) μ„¤μ • κ°€λ¥

**λ‹¨μ :**
- λ…μ‹μ μΈ unlock() μ²λ¦¬ ν•„μ”
- synchronizedλ³΄λ‹¤ λ³µμ΅ν• κµ¬ν„

#### 2.3 μ‚¬μ©μλ³„ μ„Έλ¶„ν™”λ λ½ (ConcurrentHashMap + Lock)
```java
private final ConcurrentHashMap<Long, ReentrantLock> userLocks = new ConcurrentHashMap<>();

private ReentrantLock getUserLock(long userId) {
    return userLocks.computeIfAbsent(userId, k -> new ReentrantLock());
}
```

**μ¥μ :**
- μ‚¬μ©μλ³„ λ…λ¦½μ μΈ λ½μΌλ΅ μ„±λ¥ μµμ ν™”
- λ‹¤λ¥Έ μ‚¬μ©μ μ”μ²­μ— μν–¥ μ—†μ
- ν™•μ¥μ„±μ΄ μΆ‹μ

**λ‹¨μ :**
- λ©”λ¨λ¦¬ μ‚¬μ©λ‰ μ¦κ°€ (μ‚¬μ©μλ³„ λ½ κ°μ²΄)
- λ½ κ°μ²΄ μ •λ¦¬ λ΅μ§ ν•„μ”
- κµ¬ν„ λ³µμ΅λ„ μ¦κ°€

#### 2.4 λ°μ΄ν„°λ² μ΄μ¤ λ λ²¨ λ½
```sql
-- λΉ„κ΄€μ  λ½ (Pessimistic Lock)
SELECT * FROM user_point WHERE user_id = ? FOR UPDATE;

-- λ‚™κ΄€μ  λ½ (Optimistic Lock)  
UPDATE user_point SET point = ?, version = version + 1 
WHERE user_id = ? AND version = ?;
```

**μ¥μ :**
- λ¶„μ‚° ν™κ²½μ—μ„λ„ λ™μ‘
- λ°μ΄ν„°λ² μ΄μ¤ νΈλμ­μ…κ³Ό μ—°κ³„
- μ—¬λ¬ μ• ν”λ¦¬μΌ€μ΄μ… μΈμ¤ν„΄μ¤ κ°„ λ™μ‹μ„± μ μ–΄

**λ‹¨μ :**
- λ°μ΄ν„°λ² μ΄μ¤ μ„±λ¥μ— μμ΅΄
- λ„¤νΈμ›ν¬ μ§€μ—° μ‹κ°„ μ¦κ°€
- λ°λ“λ½ κ°€λ¥μ„±

### 3. μ„ νƒν• ν•΄κ²°λ°©μ•: μ‚¬μ©μλ³„ μ„Έλ¶„ν™”λ λ½

#### 3.1 μ„ νƒ κ·Όκ±°
1. **μ„±λ¥ μµμ ν™”**: μ‚¬μ©μλ³„ λ…λ¦½μ μΈ λ½μΌλ΅ λ‹¤λ¥Έ μ‚¬μ©μμ—κ² μν–¥ μ—†μ
2. **ν™•μ¥μ„±**: μ‚¬μ©μ μ μ¦κ°€μ— λ€μ‘ κ°€λ¥ν• κµ¬μ΅°
3. **λ©”λ¨λ¦¬ μΈ-λ©”λ¨λ¦¬ μ²λ¦¬**: ν„μ¬ λ©”λ¨λ¦¬ κΈ°λ° λ°μ΄ν„° κµ¬μ΅°μ— μ ν•©
4. **κµ¬ν„ λ³µμ΅λ„**: ν•©λ¦¬μ μΈ μμ¤€μ λ³µμ΅λ„λ΅ κ΄€λ¦¬ κ°€λ¥

#### 3.2 κµ¬ν„ μ „λµ
```java
@Service
public class PointService {
    private final ConcurrentHashMap<Long, ReentrantLock> userLocks = new ConcurrentHashMap<>();
    
    private void executeWithUserLock(long userId, Runnable operation) {
        ReentrantLock lock = userLocks.computeIfAbsent(userId, k -> new ReentrantLock());
        lock.lock();
        try {
            operation.run();
        } finally {
            lock.unlock();
        }
    }
}
```

#### 3.3 κ³ λ ¤μ‚¬ν•­
- **λ©”λ¨λ¦¬ κ΄€λ¦¬**: μ‚¬μ©ν•μ§€ μ•λ” λ½ κ°μ²΄ μ •λ¦¬ λ©”μ»¤λ‹μ¦ ν•„μ”
- **κ³µμ •μ„±**: μ”μ²­ μμ„ λ³΄μ¥μ„ μ„ν• fair lock μ‚¬μ© κ²€ν† 
- **λ¨λ‹ν„°λ§**: λ½ λ€κΈ° μ‹κ°„ λ° κ²½ν•© μƒν™© λ¨λ‹ν„°λ§

### 4. μ„±λ¥ μν–¥λ„ λ¶„μ„

#### 4.1 μμƒ μ„±λ¥ μ§€ν‘
- **μ²λ¦¬λ‰(Throughput)**: μ‚¬μ©μλ³„ λ½μΌλ΅ μΈν• μ²λ¦¬λ‰ ν–¥μƒ μμƒ
- **μ‘λ‹µμ‹κ°„(Response Time)**: λ½ λ€κΈ°λ΅ μΈν• μ†ν­ μ¦κ°€ μμƒ  
- **CPU μ‚¬μ©λ¥ **: λ½ κ΄€λ¦¬ μ¤λ²„ν—¤λ“λ΅ μΈν• μ†ν­ μ¦κ°€
- **λ©”λ¨λ¦¬ μ‚¬μ©λ¥ **: μ‚¬μ©μλ³„ λ½ κ°μ²΄λ΅ μΈν• μ¦κ°€

#### 4.2 μ„±λ¥ μµμ ν™” λ°©μ•
- λ½ νƒ€μ„μ•„μ›ƒ μ„¤μ •μΌλ΅ λ¬΄ν• λ€κΈ° λ°©μ§€
- μ£ΌκΈ°μ μΈ μ‚¬μ©ν•μ§€ μ•λ” λ½ κ°μ²΄ μ •λ¦¬
- λ½ κ²½ν•© μƒν™© λ¨λ‹ν„°λ§ λ° μ•λ¦Ό

### 5. ν…μ¤νΈ μ „λµ

#### 5.1 λ‹¨μ„ ν…μ¤νΈ
- λ‹¨μΌ μ‚¬μ©μ μ‹λ‚λ¦¬μ¤ ν…μ¤νΈ
- μμ™Έ μƒν™© μ²λ¦¬ ν…μ¤νΈ

#### 5.2 λ™μ‹μ„± ν…μ¤νΈ  
- λ‹¤μ¤‘ μ¤λ λ“ ν™κ²½μ—μ„ λ°μ΄ν„° μ •ν•©μ„± κ²€μ¦
- λ½ λ€κΈ° μ‹κ°„ μΈ΅μ •
- λ°λ“λ½ λ°μƒ μ—¬λ¶€ ν™•μΈ

#### 5.3 μ„±λ¥ ν…μ¤νΈ
- λ¶€ν• ν…μ¤νΈλ¥Ό ν†µν• μ²λ¦¬λ‰ μΈ΅μ •
- λ©”λ¨λ¦¬ μ‚¬μ©λ‰ λ¨λ‹ν„°λ§
- λ½ κ²½ν•© μƒν™© λ¶„μ„

### 6. κ²°λ΅ 
μ‚¬μ©μλ³„ μ„Έλ¶„ν™”λ λ½ λ°©μ‹μ„ ν†µν•΄ ν¬μΈνΈ μ‹μ¤ν…μ λ™μ‹μ„± λ¬Έμ λ¥Ό ν•΄κ²°ν•κ³ , μ„±λ¥κ³Ό ν™•μ¥μ„±μ„ λ™μ‹μ— ν™•λ³΄ν•  μ μλ” κµ¬μ΅°λ¥Ό κµ¬ν„ν–μµλ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ λ‹¤μ¤‘ μ‚¬μ©μ ν™κ²½μ—μ„λ„ λ°μ΄ν„° μ •ν•©μ„±μ„ λ³΄μ¥ν•λ©΄μ„ μ‹μ¤ν… μ„±λ¥μ„ μµμ ν™”ν•  μ μμµλ‹λ‹¤.
